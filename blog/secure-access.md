# 如何安全的暴露内网服务？

## 前言：你是不是也遇到过这些问题？

如果你经常混迹于运维群、技术论坛，一定见过这样的提问：

- "frp 暴露 SSH 端口安全吗？怎么防止被爆破？"
- "公司内网有个 GitLab，想在家访问，用 frp 安全吗？"
- "frp 转发后，日志里全是扫描和攻击，怎么办？"
- "想用 VPN，但配置太复杂，有没有更简单的方案？"

这些问题的背后，其实都指向同一个痛点：**如何安全、便捷地访问内网服务？**

## 传统方案的困境

在介绍解决方案之前，让我们先看看现有方案的局限性。

### frp：简单但不够安全

frp (Fast Reverse Proxy) 确实是一个优秀的内网穿透工具，配置简单、性能优秀。但它的设计初衷是**解决网络连通性**，而非**安全性**。

**主要问题：**

1. **直接暴露服务到公网**
   - 你的 SSH、RDP、Web 服务直接面对整个互联网
   - 任何人都可以尝试连接，你的服务器会遭受持续的扫描和暴力破解

2. **缺乏统一的认证和授权**
   - frp 只负责转发流量，不管理"谁可以访问"
   - 安全性完全依赖后端服务本身（SSH密码强度、RDP 配置等）
   - 无法做精细化的权限控制

3. **容易成为攻击目标**
   - 看看你的 SSH 日志：每天数百甚至上千次的登录尝试
   - RDP 端口一旦暴露，扫描器会蜂拥而至
   - 即使改了默认端口，也只是"掩耳盗铃"

4. **缺少审计能力**
   - 谁在什么时间访问了什么服务？
   - 执行了哪些操作？
   - 出了问题，难以追溯

**典型场景：**

```bash
# frp 配置示例
[ssh]
type = tcp
local_ip = 192.168.1.10
local_port = 22
remote_port = 6000  # 直接暴露到公网

# 结果：全世界都能尝试连接你的 SSH
```

### VPN：安全但太繁琐

VPN 是一个更安全的选择，但它有自己的问题。

**主要问题：**

1. **配置复杂**
   - 需要安装和配置 VPN 服务端（OpenVPN、WireGuard 等）
   - 生成证书、配置路由、防火墙规则...
   - 对非技术人员来说，门槛很高

2. **客户端依赖**
   - 每个设备都需要安装 VPN 客户端
   - 不同平台（Windows、Mac、Linux、iOS、Android）需要分别配置
   - 更换设备时，又要重新配置一遍

3. **移动端体验差**
   - 需要手动连接和断开
   - 持续连接会增加耗电
   - 在移动网络和 Wi-Fi 切换时可能断连

4. **横向移动风险**
   - "一点被攻破，全网皆可达"
   - 一旦 VPN 账号被窃取，攻击者可以访问整个内网
   - 无法针对单个服务做精细化权限控制

5. **网络性能影响**
   - 所有流量都经过 VPN，可能影响速度
   - 对于只需要访问个别服务的场景，有些"杀鸡用牛刀"

## 更好的方案：Next Terminal + 安全网关

如果有一个工具，能够：
- ✅ 像 frp 一样简单配置
- ✅ 比 VPN 更安全
- ✅ 无需安装客户端，浏览器即用
- ✅ 支持精细化权限控制
- ✅ 完整的审计日志

这就是 **Next Terminal**。

### 核心理念：零信任访问

Next Terminal 采用**零信任**安全模型：

1. **先认证**：用户必须先登录 Next Terminal
2. **后授权**：系统检查用户是否有权限访问目标服务
3. **再访问**：验证通过后，才允许访问
4. **全记录**：所有访问行为都有审计日志

### 支持的服务类型

Next Terminal 不仅仅是一个 Web 代理工具，它支持：

- **SSH**：远程终端访问，支持会话录像
- **RDP**：Windows 远程桌面
- **VNC**：图形化界面访问
- **Telnet**：传统设备管理
- **Web 资产**：内网网站和 Web 应用（本文重点）

## 实战演示：暴露内网服务只需几步

让我们通过一个实际场景来对比三种方案的差异。

### 场景：安全访问内网 GitLab

假设你的内网有一个 GitLab 服务（`192.168.1.10:80`），你希望在外网也能访问。

#### 方案一：使用 frp

**步骤：**

1. 在服务器上部署 frps（frp server）
2. 在内网机器上部署 frpc（frp client）
3. 配置 frpc.ini：
   ```ini
   [gitlab]
   type = tcp
   local_ip = 192.168.1.10
   local_port = 80
   remote_port = 8080
   ```
4. 配置防火墙规则，尝试限制访问 IP（如果用户 IP 是动态的，这一步很难）
5. 访问：`http://your-server:8080`

**问题：**
- ❌ GitLab 直接暴露到公网，任何人都能访问登录页面
- ❌ 如果 GitLab 存在漏洞，直接暴露风险
- ❌ 无法做到"只让特定的人访问"
- ❌ 需要记住端口号（8080）

#### 方案二：使用 VPN

**步骤：**

1. 在服务器上安装 VPN 服务（如 WireGuard）
2. 生成服务端和客户端配置
3. 在每个需要访问的设备上：
   - 安装 VPN 客户端
   - 导入配置文件
   - 连接 VPN
4. 访问：`http://192.168.1.10`（需要保持 VPN 连接）

**问题：**
- ⚠️ 配置复杂，需要一定技术能力
- ⚠️ 每个设备都需要安装和配置
- ⚠️ 移动端使用不便（需要手动连接）
- ⚠️ 一旦 VPN 账号泄露，攻击者可以访问整个内网

#### 方案三：使用 Next Terminal

**步骤：**

1. **部署 Next Terminal**（一次性操作）
   ```bash
   docker-compose up -d
   ```

2. **启用反向代理功能**（修改配置文件）
   ```yaml
   App:
     ReverseProxy:
       Enabled: true
       HttpsEnabled: true
       HttpsAddr: ":443"
       SelfProxyEnabled: true
       SelfDomain: "nt.yourdomain.com"
   ```

3. **添加 Web 资产**（Web 界面点几下）
   - 名称：内部 GitLab
   - 域名：`gitlab.yourdomain.com`（用户访问的域名）
   - 资产 IP：`192.168.1.10`
   - 资产端口：`80`
   - 资产协议：`HTTP`

4. **授权用户**
   - 选择需要访问 GitLab 的用户或用户组
   - 点击"授权"

5. **访问**
   - 用户打开浏览器，输入：`https://gitlab.yourdomain.com`
   - 如果未登录，自动跳转到 Next Terminal 登录页
   - 登录后，自动跳转到 GitLab
   - **整个过程无需记住端口号，无需安装任何客户端！**

**优势：**
- ✅ 用户必须先登录 Next Terminal，再访问 GitLab
- ✅ 可以精确控制"谁可以访问 GitLab"
- ✅ 使用标准域名和 HTTPS，体验和直接访问公网网站无异
- ✅ 所有访问行为都有日志记录
- ✅ 移动端友好，浏览器打开即用

### 在线演示

我们提供了一个在线演示环境，让你直观体验 Next Terminal 的 Web 资产代理功能。

**演示地址：** [https://baidu.typesafe.cn](https://baidu.typesafe.cn)

这个演示模拟了一个"内网服务"，你需要：
1. 访问 [https://baidu.typesafe.cn](https://baidu.typesafe.cn)
2. 自动跳转到 Next Terminal 登录页
3. 使用测试账号登录：**用户名：test / 密码：test**
4. 登录成功后，自动跳转到目标网站

**这就是 Next Terminal 的核心优势**：用户无需记住复杂的端口号，无需安装任何客户端，只需通过标准域名访问，系统会自动完成认证和授权，体验和访问公网网站完全一致。

## 三种方案对比

| 对比维度 | frp | VPN | Next Terminal |
|---------|-----|-----|---------------|
| **安全性** | ❌ 服务直接暴露到公网 | ✅ 加密传输 | ✅ 零信任模型，先认证后访问 |
| **配置难度** | ⚠️ 中等（需要配置服务端和客户端） | ❌ 复杂（证书、路由、客户端配置） | ✅ 简单（Web 界面点几下） |
| **权限控制** | ❌ 无（完全依赖后端服务） | ⚠️ 粗粒度（VPN 连上就能访问全部） | ✅ 精细化（按用户、按资产授权） |
| **横向移动风险** | ❌ 高（单个服务被攻破可能影响其他） | ⚠️ 高（VPN 账号泄露可访问整个内网） | ✅ 低（权限隔离，只能访问授权的资产） |
| **客户端依赖** | ✅ 无需客户端 | ❌ 每个设备需要安装和配置 | ✅ 无需客户端，浏览器即用 |
| **移动端体验** | ⚠️ 需要记住端口，可能有防火墙限制 | ❌ 需要安装 VPN 客户端，手动连接 | ✅ 浏览器访问，体验流畅 |
| **审计日志** | ❌ 无（只有转发记录） | ⚠️ 有限（只有连接记录） | ✅ 完整（谁、何时、访问了什么） |
| **多云环境** | ⚠️ 需要在每个网络单独配置 | ⚠️ 复杂（需要配置路由） | ✅ 统一管理（安全网关） |
| **用户体验** | ⚠️ 需要记住端口号 | ❌ 需要手动连接/断开 VPN | ✅ 标准域名，HTTPS，无感知 |
| **适用场景** | 个人测试、临时使用 | 需要访问整个内网的场景 | 生产环境、团队协作 |

## 高级场景：多云环境与安全网关

Next Terminal 还有一个强大的功能：**安全网关**。

### 场景：跨云访问内网服务

假设你的服务分布在不同的网络环境：
- 阿里云内网：服务 A、B
- 腾讯云内网：服务 C、D
- 本地机房（无公网 IP）：服务 E、F

**传统方案的困境：**
- frp：需要在每个网络环境部署 frps 或 frpc，配置复杂
- VPN：需要打通多个网络，路由配置复杂

**Next Terminal 方案：**

1. 在 Next Terminal 服务器（有公网 IP）部署主程序
2. 在每个内网环境部署一个**安全网关**（agent）
   - 在 Next Terminal 管理界面中，进入"安全网关"页面
   - 点击"添加"按钮，复制生成的一键安装命令
   - 在内网服务器上粘贴并执行该命令即可
   - 安装完成后，网关会自动注册到 Next Terminal
3. 在 Next Terminal 中添加资产时，选择对应的安全网关
4. 访问时，Next Terminal 会自动通过对应的网关访问内网服务

**优势：**
- ✅ 统一入口：所有资产通过一个 Next Terminal 访问
- ✅ 网络隔离：不同网络环境的服务互相不可见
- ✅ 配置简单：安全网关部署是一条命令的事
- ✅ 动态扩展：新增网络环境时，只需部署一个新网关

更多配置详见：
- [安装文档](../install/container-install.md)
- [Web 资产配置](../usage/website.md)
- [安全网关文档](../usage/agent-gateway.md)
